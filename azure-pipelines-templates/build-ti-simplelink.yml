# Copyright (c) .NET Foundation and Contributors
# See LICENSE file in the project root for full license information.

parameters:
  buildDirectory: '$(Build.SourcesDirectory)'

steps:

  # Rename CMakeUserPresets for CI
  - task: PowerShell@2
    displayName: Rename CMakeUserPresets
    inputs:
      workingDirectory:  ${{ parameters.buildDirectory }}
      targetType: 'inline'
      script: Rename-Item -Path "CMakeUserPresets.CI.json" -NewName "CMakeUserPresets.json"

  - task: CMake@1
    inputs:
      cmakeArgs: ' --preset $(TargetBoard) -DTOOLCHAIN_PREFIX=$(GNU_GCC_TOOLCHAIN_PATH) -DCMAKE_BUILD_TYPE=MinSizeRel -DBUILD_VERSION=$(NBGV_VersionMajor).$(NBGV_VersionMinor).$(NBGV_BuildNumber).$(TARGET_BUILD_COUNTER) -DTARGET_BOARD=$(TargetBoard) -DTARGET_NAME=$(TargetPublishName) $(BuildOptions)'
      workingDirectory:  ${{ parameters.buildDirectory }}
    displayName: Setup build with CMake

  - task: CMake@1
    inputs:
      cmakeArgs: '--build --preset $(TargetBoard) --target all --config MinSizeRel'
      workingDirectory:  ${{ parameters.buildDirectory }}
    displayName: Build with CMake

  # Revert rename
  - task: PowerShell@2
    displayName: Rename CMakeUserPresets
    inputs:
      workingDirectory:  ${{ parameters.buildDirectory }}
      targetType: 'inline'
      script: Rename-Item -Path "CMakeUserPresets.json" -NewName "CMakeUserPresets.CI.json"
